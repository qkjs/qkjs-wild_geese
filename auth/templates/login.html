<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta Content-Type="application/json; charset=UTF-8">
	<title>登录</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			max-width: 400px;
			margin: 100px auto;
			padding: 20px;
			background-color: #f5f5f5;
		}
		.login-form {
			background: white;
			padding: 30px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		.form-group {
			margin-bottom: 15px;
		}
		label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
		}
		input[type="text"], input[type="password"] {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 4px;
			box-sizing: border-box;
		}
		button {
			width: 100%;
			padding: 12px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
		}
		button:hover {
			background-color: #0056b3;
		}
		.flash-messages {
			margin-bottom: 20px;
		}
		.flash-message {
			padding: 10px;
			border-radius: 4px;
			margin-bottom: 10px;
		}
		.flash-success {
			background-color: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}
		.flash-error {
			background-color: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}
		.flash-info {
			background-color: #d1ecf1;
			color: #0c5460;
			border: 1px solid #bee5eb;
		}
		.links {
			text-align: center;
			margin-top: 20px;
		}
		.links a {
			color: #007bff;
			text-decoration: none;
			margin: 0 10px;
		}
		.links a:hover {
			text-decoration: underline;
		}
	</style>
	<script>
		// 保护：若 JS 报错不影响页面渲染
	</script>
</head>
<body>
	<div class="login-form">
		<h2>用户登录</h2>
        
		<!-- Flash消息 -->
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				<div class="flash-messages">
					{% for category, message in messages %}
						<div class="flash-message flash-{{ category }}">{{ message }}</div>
					{% endfor %}
				</div>
			{% endif %}
		{% endwith %}
        
		<form id="login-form" method="POST">
			<div class="form-group">
				<label for="username">用户名：</label>
				<input type="text" id="username" name="username" required>
			</div>
            
			<div class="form-group">
				<label for="password">密码：</label>
				<input type="password" id="password" name="password" required>
			</div>
            
			<button type="submit">登录</button>
		</form>
        
		<div class="links">
			<a href="{{ url_for('auth.page_register') }}">注册账号</a> |
			<a href="{{ url_for('index') }}">返回首页</a>
		</div>
	</div>
	<script>
		(function() {
			const form = document.getElementById('login-form');
			const flashContainer = document.querySelector('.flash-messages') || (function(){
				const c = document.createElement('div');
				c.className = 'flash-messages';
				form.parentNode.insertBefore(c, form);
				return c;
			})();

			function showMessage(msg, type) {
				const div = document.createElement('div');
				div.className = `flash-message flash-${type || 'info'}`;
				div.textContent = msg;
				flashContainer.innerHTML = '';
				flashContainer.appendChild(div);
			}

			form.addEventListener('submit', async function(e) {
				e.preventDefault();
				const username = document.getElementById('username').value.trim();
				const password = document.getElementById('password').value;
				const submitBtn = form.querySelector('button[type="submit"]');

				if (!username || !password) {
					showMessage('请输入用户名和密码。', 'error');
					return;
				}

				submitBtn.disabled = true;
				try {
					const resp = await fetch("{{ url_for('auth.api_login') }}", {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Accept': 'application/json'
						},
						credentials: 'same-origin',
						body: JSON.stringify({ username, password })
					});

					let data = null;
					try { data = await resp.json(); } catch (_) { data = null; }

					if (resp.ok && data && data.ok) {
						// 登录成功 -> 跳转首页
						window.location.href = "{{ url_for('index') }}";
					} else {
						const detail = data && (data.error || data.detail);
						showMessage(detail ? `登录失败：${detail}` : '登录失败：请检查用户名或密码。', 'error');
					}
				} catch (err) {
					showMessage('网络异常或服务器不可用，请稍后重试。', 'error');
				} finally {
					submitBtn.disabled = false;
				}
			});
		})();
	</script>
</body>
</html>
